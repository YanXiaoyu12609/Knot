import { GoogleGenerativeAI } from "@google/generative-ai";

const PROMPT_TEMPLATE = `
---
### **终极学术论文分析Prompt (全面且灵活的Obsidian版)**

**角色设定**: 你是一位顶尖的科研学者与专业的分析师，拥有卓越的逻辑思维、深刻的洞察力，并精通将复杂学术内容提炼为清晰、易读、结构化报告的艺术。

**核心任务**: 基于我提供的学术论文PDF，生成一份详尽但简洁、深度与广度兼备、完全为Obsidian优化的分析报告。你的报告将以流畅自然的语言，系统回答用户提出的关键问题，并突出论文的价值。

**核心原则 (必须严格遵守)**:

1.  **信息完整性**: 报告必须包含以下所有核心信息：
    *   **论文试图解决的问题**
    *   **相关研究概览**
    *   **文章如何解决问题（包括步骤、模型的假设、核心公式）**
    *   **原理-数据-公式的深度分析**
    *   **文章的逻辑-证据链条**
    *   **论文进行的关键实验及其验证作用**
    *   **论文最主要的创新点和贡献**
    *   **可以进一步探索的方向**
    *   **一份全面精炼的总结**
2.  **简洁与深度平衡**: 在保证信息完整性的前提下，尽可能用凝练的语言表达，避免冗余细节。重点突出，而非堆砌。
3.  **语言灵活性**: 在内容的具体阐述上，你可以使用流畅自然的中文表达，无需拘泥于固定的句式模板，但要保持学术严谨性。
4.  **Obsidian原生格式**: 严格遵守模板中的YAML前言、\`[[双向链接]]\`、\`#标签\`和\`[!callout]\`语法，确保报告能无缝导入Obsidian并发挥其所有功能。

**最终报告模板 (你必须用于输出的格式)**:

---
title: "论文的完整标题"
aliases: ["论文简称或缩写", "作者姓氏 年份"]
tags: [] # 必须使用英文，小写，短横线连接。保持标签整洁，避免同义词（例如只用 "deep-learning" 不用 "dl" 或 "deep learning"）。
authors: ["[[作者A]]", "[[作者B]]"]
publication: "期刊或会议名称" # 如果包含特殊字符（如冒号），必须使用双引号包裹
year: 2024
doi: "10.xxxx/xxxxxxx"
url: "https://doi.org/..."
---

> [!abstract] **精炼总结 (Concise Summary)**
> [**总结一下主要内容**。在此处撰写一份约300-500字的精炼中文总结。这段总结应流畅、准确、专业地串联起**研究背景与所解决的问题、该领域的相关工作、论文提出的核心方法与模型（包括其基本原理）、关键实验如何验证了其效用、以及最终研究的核心结论和主要贡献**。]

---
### **1. 研究问题与背景 (Research Problem & Context)**

*   **这篇文章试图解决什么问题？(The Core Problem)**:
    *   [清晰阐述论文旨在解决的具体科学或技术挑战，以及现有方法在解决此问题上的不足或存在的理论空白。]

*   **有哪些相关研究？(Related Work Overview)**:
    *   [简要概述论文引言和相关工作部分提及的、与本文直接相关的现有主流研究方向、代表性方法或核心理论。说明它们是如何为本文研究奠定基础，或本文与它们形成了何种对比/补充关系。]

---
### **2. 核心方法、原理与论证 (Core Method, Principles & Logic)**

> [!tip] **文章的逻辑-证据链条 (Logic & Evidential Chain)**
> [详细解释作者从提出问题、构建假设、设计方法、进行实验到得出结论的整个论证过程。阐明论文的整体叙事逻辑，以及数据和发现如何一步步支撑其核心主张。]

*   **文章如何解决这个问题？(How it Solves the Problem)**:
    *   **核心解决思路**: [概述作者提出的解决方案的核心思想或创新点。]
    *   **关键步骤与流程**: [简要描述实现该方法的主要步骤或流程，形成一个清晰的执行链条。]

*   **原理-数据-公式深度分析 (Principles, Data, Formulas Analysis)**:
    *   **核心方法/模型原理**: [**分析这篇文章的原理**。深入解释核心方法或模型的工作原理、内部机制、关键组件及其相互作用方式。]
    *   **关键假设**: [阐述模型或方法赖以成立的关键假设或前提条件，它们对方法的适用性有何影响。]
    *   **核心公式**: [**分析这篇文章的公式**。列出并解释模型中最具代表性和决定性的数学公式。解释每个公式在方法中的具体作用、物理意义或推导逻辑。]
        $$
        \text{LaTex Formula Here}
        $$
        *   **符号解释**: [简要定义公式中的所有重要符号。]

---
### **3. 实验设计、数据与验证 (Experiments, Data & Validation)**

> [!note] **论文做了哪些实验？(Experiments Conducted)**
> 作者通过一系列精心设计的实验来验证其方法的有效性、鲁棒性和优越性。

*   **实验一: [实验目的，例如：主要性能评估与基线对比]**
    *   **实验设置**: [概述所用的数据集、核心评估指标、以及与哪些现有或代表性方法进行了比较。]
    *   **主要结果与验证 (关联图表: \`Table X\`, \`Figure Y\`)**: [**分析这篇文章的数据**。详细描述实验结果中最重要的发现，突出关键的量化数据。阐明这些结果如何有力地验证了论文的某个关键主张（例如，作者的方法在特定指标上显著优于现有方法，或解决了某个长期存在的问题）。]

*   **实验二: [实验目的，例如：消融研究或特定组件有效性验证]**
    *   **实验设置**: [描述此实验的设计细节，例如，为了验证模型中某个特定组件（如注意力机制、某个模块）的作用，作者是如何通过修改或移除该组件进行对比的。]
    *   **主要结果与验证 (关联图表: \`Table A\`, \`Figure B\`)**: [阐述实验结果中最重要的发现，解释这些结果如何验证了某个设计选择的合理性，或证明了某个组件在整个方案中的关键作用。]

---
### **4. 核心创新与贡献 (Key Innovations and Contributions)**

> [!success] **本文最主要的创新点和贡献是什么？**
>
> 1.  **方法/模型创新**: [清晰阐述论文在方法论、模型架构或算法设计上的独特之处，例如：它引入了哪些新颖的组件或思路，解决了什么技术瓶颈。]
> 2.  **理论/概念创新**: [如果论文在理论框架的构建、概念的提出或对某个现象的全新解释上有所突破，请在此描述。]
> 3.  **实验/实证贡献**: [说明论文在创建新数据集、建立新的评估基准、或通过严谨的实验设计首次验证了某个重要现象方面的贡献。]

---
### **5. 局限性与未来方向 (Limitations & Future Directions)**

> [!warning] **论文的局限性**
> > 作者在论文中明确指出了其研究的某些局限之处，例如：[列出论文中提及的局限性，并简要解释这些局限性可能对其结论适用范围或泛化能力产生的影响。]

> [!idea] **有什么可以进一步探索的点？(Future Research Suggestions)**
> > 基于当前研究，作者和你可以从以下几个方面继续探索，以深化理解或拓展应用：
>
> 1.  **方向一 (改进现有局限)**: [针对论文中提到的或你分析出的局限性，提出具体的改进方向或技术方案。]
> 2.  **方向二 (拓展应用场景)**: [提出将本文方法或理论应用于其他相关或更具挑战性的领域/任务的可能性。]
> 3.  **方向三 (深化理论或机制)**: [建议对论文中某些尚未完全阐明的内在机理进行更深入的理论分析、建模或实证研究。]

---
### **6. 参考文献列表 (References List)**

> [!info] **提取的参考文献**
> 请从论文末尾的参考文献部分提取所有引用的文献，并以结构化JSON格式输出。

\`\`\`json
[
  {
    "index": 1,
    "text": "完整的参考文献文本",
    "authors": "作者姓名",
    "title": "文献标题",
    "year": "出版年份",
    "doi": "DOI（如有）"
  }
]
\`\`\`

**注意**: 请确保提取论文中引用的所有参考文献，包括序号、完整文本、作者、标题、年份和DOI（如果有）。

---
`;


export async function analyzePdfWithGemini(apiKey: string, pdfData: Blob, modelName: string = "gemini-2.0-flash"): Promise<string> {
    const genAI = new GoogleGenerativeAI(apiKey);
    const model = genAI.getGenerativeModel({ model: modelName });

    // Convert Blob to Base64
    const base64Data = await blobToBase64(pdfData);

    const result = await model.generateContent([
        {
            inlineData: {
                data: base64Data,
                mimeType: "application/pdf",
            },
        },
        PROMPT_TEMPLATE,
    ]);

    return result.response.text();
}

function blobToBase64(blob: Blob): Promise<string> {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            const base64String = (reader.result as string).split(',')[1];
            resolve(base64String);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}
